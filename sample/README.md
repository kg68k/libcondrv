# libcondrvサンプル

あらかじめ、ライブラリファイルとインクルードファイルをそれぞれ
所定のディレクトリにインストールしてください。
このディレクトリに置くだけでも構いません。


## サンプルコード

### sample.c

キーペーストと`IOCS _KEY_INIT`フック以外の機能を使用するサンプルです。

condrv(em).sysが組み込まれているかどうかはライブライリ側で調べているので、
`condrv_xoff()`や`condrv_xon()`などを使う前に個別に調べる必要はありません。

`condrv_xoff()`を呼び出した後にプログラムがアボートすると、
`condrv_xon()`が呼び出されないため停止レベルがずれてしまいます。
このサンプルではそれを防ぐ為にsignal機構を使用しています。
アボートする恐れが少なければそこまでしなくても構わないと思います
(万が一アボートしてしまったらxcontを使えば戻せます)。


### kp.c

キーペーストを行うサンプルです。
各引数の末尾に`CR`を付けてペーストバッファに書き込みます(複数指定可)。
あらかじめバッファサイズを収得し、1バイトでも足りなかったらエラー終了しています。

使用例: `kp uskcgm lc:/sys/uskcg.sys`  
(uskcgmを起動し、c:/sys/uskcg.sysをシステムに登録する)


### kp2.c
キーペーストを行うサンプルです。

一度ペーストしたものをユーザのキー操作で再びペーストして欲しくないときや、
condrv(em).sysが確保しているペーストバッファを破壊したくないときは、
このサンプルのように`condrv_keypaste()`ではなく`condrv_keypaste_once()`を使います。
この関数はバッファをアプリケーション側で用意しなければなりませんが、
ペーストバッファの容量を確認する手間が不要です。

バッファとして`0x2000`からの1KBを使用していますが、実用の際、例えばデバイスドライバや
常駐プログラムならそれぞれのプログラムが内部に確保することになります。
また、そのような場合はバッファを何度も書き換えると思いますが、
ペースト中に書き換えると正しくペーストされないので、
バッファ書き換え前に`condrv_stop_paste()`でペーストを中断して下さい。


## Build

リリースパッケージに含まれるファイルはShift_JISに変換されているので、そのままビルドできます。

リポジトリ内のファイルについては、
PCやネット上での取り扱いを用意にするために、src/内のファイルはUTF-8で記述されています。
X680x0上でビルドする際には、UTF-8からShift_JISへの変換が必要です。

### u8tosjを使用する方法

あらかじめ、[u8tosj](https://github.com/kg68k/u8tosj)をビルドしてインストールしておいてください。

トップディレクトリで`make`を実行してください。以下の処理が行われます。
1. build/ディレクトリの作成。
2. src/内の各ファイルをShift_JISに変換してbuild/へ保存。

次に、カレントディレクトリをbuild/に変更し、`make`を実行してください。  
実行ファイルが作成されます。

### u8tosjを使用しない方法

ファイルを適当なツールで適宜Shift_JISに変換してから`make`を実行してください。  
UTF-8のままでは正しくビルドできませんので注意してください。


## License

GNU GENERAL PUBLIC LICENSE Version 3 or later.


## Author

TcbnErik / 立花@桑島技研  
https://github.com/kg68k/libcondrv
